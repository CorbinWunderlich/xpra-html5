<!DOCTYPE html>
<html lang="en">
  <head>
    <!--
	Copyright (c) 2024 Antoine Martin <antoine@xpra.org>
	Licensed under MPL 2.0
	-->

    <title>Xpra HTML5 AES Test Page</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" type="image/png" href="favicon.png" />

  </head>

  <body>
    <div class="container">
      <div>
        <pre id="info"></pre>
      </div>

    </div>

    <script>
        const info = document.getElementById("info");
        const lines = [];

        function u8(value) {
            const type = typeof value;
            if (type === 'object' && value.constructor === Uint8Array) {
                return value;
            }
            if (type == "string") {
                return Uint8Array.from(value.split("").map(x => x.charCodeAt()));
            }
            return new Uint8Array(value);
        }

        function str(u8array) {
            var s = "";
            for (var i = 0; i < u8array.length; i++) {
                s += String.fromCharCode(u8array[i]);
            }
            return s;
        }

        function arrayhex(arr) {
            const u8array = new Uint8Array(arr);
            return Array.from(u8array).map((b) => b.toString(16).padStart(2, "0")).join("");
        }

        function hexarray(hex) {
            var bytes = new Uint8Array(Math.ceil(hex.length / 2));
            for (var i = 0; i < bytes.length; i++) {
                bytes[i] = parseInt(hex.substr(i * 2, 2), 16);
            }
            return bytes;
        }

        function show(newtext) {
            console.log(newtext);
            while (lines.length>50) {
                lines.shift();
            }
            lines.push(newtext);
            info.innerText = lines.join("\n");
        }

        const key = "this is our secret";
        const salt = u8("0000000000000000");
        const key_size = 32;
        const iterations = 10000;
        const mode = "CBC";
        const key_hash = "SHA-1";
        const usage = "encrypt";
        const iv = "0000000000000000";

        const params = {
            name: "AES-"+mode,   //ie: "AES-CBC"
            iv: u8(iv),
        }

        function cmp(v1, v2) {
            const a1 = u8(v1);
            const a2 = u8(v2);
            if (a1.length != a2.length) {
                return false;
            }
            return a1.every((v,i) => v === a2[i]);
        }

        function verify(expected, actual) {
            if (!expected) {
                return;
            }
            if (cmp(expected, actual)) {
                show("             (all "+expected.length+" bytes match the expected value)");
                return;
            }
            const eu8 = u8(expected);
            const au8 = u8(actual);
            show(" mismatch:");
            show("  expected "+eu8.length+" bytes: " + eu8);
            show("  but got  "+au8.length+" bytes: " + au8);
        }

        function show_value(what, value) {
            const u8array = new Uint8Array(value);
            show(""+what+": "+JSON.stringify(str(u8array))+" ("+u8array.length+" bytes)");
        }

        function decrypt(crypto_key, encrypted, expected) {
            crypto.subtle.decrypt(params, crypto_key, encrypted)
            .then(decrypted => {
                show_value("decrypted ", decrypted);
                verify(expected, decrypted);
            })
            .catch(err => show("failed to decrypt "+encrypted.byteLength+" bytes message: "+arrayhex(encrypted)));
        }

        function encrypt(crypto_key, message, expected) {
            show_value("encrypting", message);

            crypto.subtle.encrypt(params, crypto_key, u8(message))
            .then(encrypted => {
                show_value("encrypted ", encrypted);
                verify(expected, encrypted);
                decrypt(crypto_key, encrypted, message);
            })
            .catch(err => show("failed to encrypt message"));
        }

        show("importing key '"+key+"'");
        crypto.subtle.importKey("raw", u8(key), { name: "PBKDF2" }, false, ["deriveKey", "deriveBits"])
        .then(imported_key => {
            show("imported key: "+imported_key);
            show("deriving " + mode + " key");
            show(" " + iterations + " iterations, " + key_hash + " hash, " + (key_size * 8)+ " bits");
            show(" salt=" + salt);
            // now stretch it to get the real key:
            crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: iterations,
                    hash: {name: key_hash},
                }, imported_key,
                {
                    name: "AES-"+mode,
                    length: key_size * 8,
                }, false, ["encrypt", "decrypt"],
            )
            .then(crypto_key => {
                show("derived key for " + usage + " usage: " + crypto_key);

                show("iv '"+iv+"'");
                show("-------------------------------------");

                let message = "some message1234";
                encrypt(crypto_key, u8(message));

                // try again with hard-coded encrypted message:
                let encrypted = hexarray("6339a0861384e208ed20313a649122980c79458182b8882dbf1cca137a0f88bd");
                decrypt(crypto_key, encrypted, message);

                function hexdata_test(data, enc_value) {
                    let packet_data = hexarray(data);
                    let enc_data = hexarray(enc_value);
                    encrypt(crypto_key, packet_data, enc_data);
                }

                function test_pydata() {
                    show("-------------------------------------");
                    hexdata_test(
                        "bd0b0000f42ec28568656c6c6f3c86646967657374cb83786f728b686d61632b7368613531328d686d61632b736861335f3531328d686d61632b736861335f3338348d280058335f3235360e003532348b380016380c00fa303235368b686d61632b7368613232348c686d61632b626c616b6532738c686d61632b626c616b6532628b73616c742d646967657374ca8b686d61632b7368618100443531328d4d000f8f004df6ff8c636f6d70726573736f7273c3836c7a348662726f746c69846e6f6e6588656e636f64657273c28b72656e636f6465706c7573846e6f6e6585666c75736843836c7a346780438662726f746c69678043846e6f6e656780438b72656e636f6465706c75736780438770616464696e6767876f7074696f6e73c186504b43532337856d6f64657367876f7074696f6e73c4834342438347434d8343464283435452877374726574636867876f7074696f6e73c18650424b44463293707974686f6e2d63727970746f6772617068796880438776657273696f6ec3290007846d6f64658c583131207365616d6c6573738c73657373696f6e2d74797065887365616d6c657373847575696436343a306636623537383938303662363763363861363332643237653931396633396163373536383335616165623630646265313434333738346336393666323763318a6d616368696e652d6964a065636238333837356261323234653133393666653763306136613062383263378776657273696f6e83362e328a73746172745f74696d654066fcde528c63757272656e1200fd23788c656c61707365645f74696d65268b7365727665725f747970658e507974686f6e2f67746b2f7831318b7365727665722efa00f20b88686f73746e616d65866665646f72618f726561646f6e6c792d4d002443881100ff07448a7365727665722d6c6f67808a6d616368696e655fd30010045d01f15c5f6e616d6585787465726d8a6b65795f726570656174c20000946b65795f7265706561745f6d6f64696669657273438462656c6c4487637572736f7273448c6465736b746f705f73697a65c23f04a43f059b887864672d6d656e75668b737562636f6d6d616e6473f080853901118d0600f3ff9a2d6465736b746f708d73746172742d6d6f6e69746f7286736861646f778d736861646f772d73637265656e87757067726164658f757067726164652d6465736b746f708f757067726164652d6d6f6e69746f728e757067726164652d736861646f77866174746163688873657373696f6e73886c61756e63686572836775698973746172742d6775698a6275672d7265706f727487746f6f6c626f788561626f7574876578616d706c658664657461636884696e666f8269648776657273696f6e8473746f7084657869748a73637265656e73686f7487636f6e74726f6c857072696e74857368656c6c8973656e642d66696c6589636f6e66696775726585636c65616e8d636c65616e2d736f636b6574738e636c65616e2d646973706c617973896175746f73746172748a73686f77636f6e6669678973657475702d73736c8873686f772d73736c846c6973748d6c6973742d73657373696f6e738c6c6973742d77696e646f777388646973706c61797388656e636f64696e6789706174682d696e666f8568746d6c3584646f6373896c6973742d6d646e73886d646e732d677569906d61785fa70103df01631e003f10e087a300f2fb823a318f636c69656e742d73687574646f776e438773686172696e67448e73686172696e672d746f67676c6544846c6f636b448b6c6f636b2d746f67676c65448777696e646f777343886b6579626f617264438d696e7075742d6465766963657385787465737490706f696e7465722e72656c617469766543876e6574776f726b678f62616e6477696474682d6c696d697400857368656c6c439273746172742d6e65772d636f6d6d616e64734492657869742d776974682d6368696c6472656e44977365727665722d636f6d6d616e64732d7369676e616c73c686534947494e54875349475445524d86534947485550875349474b494c4c87534947555352318753494755535232949403064700f216696e666f4393637572736f722e64656661756c745f73697a65208f637572736f722e6d61785301c23e403e408d726573697a655fef02f3ff7a438c726573697a655f6578616374438c666f7263655f756e6772616243976b6579626f6172642e666173742d737769746368696e67438d776865656c2e707265636973654490706f696e7465722e6f7074696f6e616c438f746f7563687061642d646576696365448c73637265656e2d73697a6573e7c23f1e003f10e0c23f14003f0b40c23f10003f0900c23f0f003f0870c23f0c803f0708c23f0b403f0654c23f0a003f0640c23f0a003f05a0c23f08003f0600c23f07803f05a0c23f07403f0570c23f07003f0540c23f08003f0480c23f07803f04b0c23f07803f0438c23f06403f04b0c23f06903f041ac23f05783f041ac23f06403f0384c23f05003f0400c23f05783f0384c23f05003f03c0c23f05583f0300c23f05003f0320c23f04803f0360c23f05003f02d0c23f04003f0300c23f04003f0240c23f03403f0270c23f03c03f021cc23f03203f0258c23f03603f01e6c23f02803f01e0c23f02d03f0195c23f02d03f0190c23f02803f0190c23f02803f0168c23f02803f015ec23f04a43f059b874201fbb767856772616273438677696e646f776b8d6672616d652d657874656e7473438f636f6e6669677572652e64656c746143877369676e616c73c686534947494e54875349475445524d875349475155495487534947434f4e548753494755535231875349475553523289647261676e64726f704386737461746573c88969636f6e696669656487666f63757365648a66756c6c73637265656e8561626f76658562656c6f7786737469636b798969636f6e6966696564896d6178696d697a65649361637475616cc803f8020f003f087090726f6f745f77696e646f771800f3168a656e6372797074696f6e728663697068657283414553846d6f6465834342438c6d6f646559020e0208978269769030303030300500c4886b65795f73616c7431362f1400040200011c00f134686173688453484131886b65795f73697a65208b6b65795f737472657463688650424b444632936b65795f737472657463682e6f7074696f6e73c18650424b444632966300027d08f30f5f697465726174696f6e733f27108770616464696e6786504b435323378f0f0004c10013c118001491e306f40c5f6b6579636f6465736e857368696674c2c28753686966745f4c000a00f2115200846c6f636bc1c289436170735f4c6f636b0087636f6e74726f6cc2c289430a00625f4c00c289431106f43e5f5200846d6f6431c4c2864d6574615f4c01c285416c745f4c01c200864d6574615f4cc2864d6574615f5201846d6f6432c1c2884e756d5f4c6f636b00846d6f6433c3c28753757065725f4c000a0015520a00f30a4c01846d6f6434c2c28748797065725f4c01c28748797065727800fd0835c2c29049534f5f4c6576656c335f536869667400c2001400f02a9270696e672d6563686f2d736f7572636569644388656e636f64696e67846175746f926175746f5f726566726573685f64656c61793f01f47f",
                        "9080ed5f000fc0efea6148046553745f748a5c83c5732c3bb082ce5e479daeecca56755deec748b443104738ddb928e4005895baf85a0e1f19880ef80524d6c34ff375a4bd2f74a06aae1402a6dfde453d5a45e02893ed2ce808e24c2fa9599e80ffd4fdce1a14603857ced7f38d8f6e85c89ea1e81638c4eed906ebce67ff3f3976ea691e9f35fa528035307fecd4a4a0f38bcfd82eb8fff0d312f762c05b404763e6f91f63ff2c78f4fc8beb6c2a5cceec7a215375ba4638192c401faedea0fe0adce266b8c19fe1f05a4cd435cf17569fcb397693f1e2a5987e71548364ad48cf73a4c31bbee59962d6331d761eabdcb060029af5b98e6c57e2770516cac66a5666e14e9c7e8140f763ec732688d5334557ec2e70e3dc939595938def061ad2f62dcef1964ebc6e436c62596c41cc4e0f83295d3cac2d3f3202eaee1e63d4e49c2527e32bd085a35a63f11f0d8999bb9df67d0aafe1430f3125e0a406507ed55db6207c21e554dc25c446b3da7692b15b790fd355928b62f389ff2cbbdb706aaf6e78b4a4ca575a0fb73b959d5771b017ab070cba9381be091b0fd4bd8deacb57509a2f299ea52fbe74f5ee35e8d66a382a7d15e3c1894877db17d644d29c2ba1a373fe3ae6a515c443295ca4bcbb46f63f42972eefdcf238cbe3436a313f7eec0fe5887cb7ed652b020f595a29e1b67931440166456720a3c1e836b54433e526fdfaee09a70ba8a6f4922e6cff9273f47ecbbea31cb5a7d241072ad32c72178a5713b12768602f90e127820643d30de80e4ff76e6865059f7106e1898a916865bd539b8554f7eab33a641488d797261639627d38d5bc7de20a4b9b89c58c5279578ab0a42043312410c47081b9d5c3013dca84d6ce7b9b54a4f8e96c227712d4e7195ca56ab217a51897951db752d2fa7c992eaaec8d5236190414c67b776a6e1f58492a00c352f307b2ab2509d79918563427ed1513d089e5711fe58c5d6fdf011999cda1007fd9013ea75edea5bb411a5775584a390801c86997c9740a9d9d2fb781c59aec3fecab8b4ecb11b78e4ca24578354858cd15fe9a4e9169aa2e2dbdc58f62ea3bcba2918eb4a11347e06053a56da83fe55e5d23814e0cc3194560806a1ab52dafc69f2e8af5071f4326c2cd38fdc40065afce4cf0a41336c8a10aadfd6ab1eb23670c10e167083e32b3bb41b59e1d8dd13305fcb609942d8a3a9800757536e758ad3c5a3c91621030667175bef84428374612094336bc76f79a186184fb59d34a5a3035b787e237adbf8e4e44c08b70a89f5a5991e7bd1f7cf93b4bb834ed634daa9001e23a3a5cebdffa88d56b492233f557e6d4bbaf29dd14429b4a11e074f3016a0382bee14e36262563b3394f54f89f133380ee12cb134226ab34a04edab335e7911b5f9ffdba3d285e7cd8f108544effa1da9358765e00f9f645c8509cb5221f77a3ec413132542fc46e3cc898e9272d881fbdbb846f056143510d1423e21ba4bd3e372c0b2fd9abb22c5e7054898b95b60f5cc6d012de95efabf45b42c0e1d36507fee4c200c7a9c45e21bc547b2c5983de603c393df649c5d4257562ead947d7a6bc2d38a810bc70e1834b7625f5d64cdc9226a78fd13acfdccb59bcc6925852d4f59abbde6b49226f1700283fea72377ac8b0e4ae1e75f944cd272bfefb8118b6d5e838f1fafa16b6d5af26cffd985ee12a01fe1b69e6dfc5004ac24149f1f78f3fe885acb42e776439362c8b56aba18ec92a748d6599885d0f9a7389e5041078b77fc8810ab4dcf90c4e0ed9e289870b4e178ac9ad8390d77714a2221dec47e79f9ffcdf3857894bc55a10dbf0b3bfb75298f015487f72569ac9d8c39a6bd512c29c4d57a2e1e2f725c9f347fddb68ea59c0f5321199770f0e19555fdf7ba94507ffa0393b614e164737418b7eb4fb0506f0b23e07bb4b9752931005e9ede824904bd7a954c38ad31b6a044fcde6b56d7f7ba6f2d2905e3ff1cb29d740098ee76b24a4f10839ba2ad78a7f91877a0a49e911d3ca9cd04a3f1a781d70dd436432ed7f214db95f93191b44d8db0ca96bae8fac2ff2532e07e36281bb2c6a9dab19ed841434c05cae696fbee3bef2e0edbcf3cb3528323b77dba5a08a8854749994f01d3f550dcc0e1d7c7819cc1eb214b7e2eb5fa0d1f6762347e93a1ce54340af295af791805162eb0e7251429db509b553283edc2b33ba8dc110c00f62aa6c08fc0b3cbc77d2d0af76412122ad1ae7179e38ac56f0cba005eca14eca70c7e38850266244a113e9df5e8111ce3c017d2da7e05d25bd50d8bf438f8e45c908d6c5a96fea9e9007013f345e70f2c8aeb42922545ecaa2bf16c998c4df0d4f989a8c4ea65c9fbe20a4107a905385e8c7dd4fbb819108b9450fc659d1c745da7416b1d31038a4bd9acc4dc0fe197657bb3229c29d8749820b2037c561bfd328222730a988d22b68454a8eeac0f709b66e7847194545a6b96063be47ace59a5c89f3438941715d5071722d700e21ae5e943190d8141420ddb8dc07bc819be8b8505da5a7030a97bf45420bb9bf424ba081d7ec579a24a8a0e84ac98897d73b9579438a6ab99b2d014ead34e90bf73fd32238461fda1be16a0b502d6ef3a4947ac37fb26653997a617f8a281b225e1ed6c5e0b44b4e67e753b8871c85c4b694d3dc4a88e492e68e9b1df0e41fcdd85b3838bd72b001cc183bcbdfc3fad11187260709abc770d809f0873db191dd0d326a5bb5cfed4444310b4b68155972c9b7c466bfcdac4f5c58cb00bd92b640251be2494bd8faef53f3fa21a9e61f803d3a503474d8a55f9cb507dd9183423e9b6744d29b03976d673d0dbab9a4b20da9b53c9b7164c00394fe6d2ecbe76bf1124fd40a7aa7c9cfd52b6f91965769da144c269222273b5cefaeaba220525b0fa0855effe93a9c3e693018ceab718aec73535ec38a9ba4742e66d52d62a07324e73dd3a9bcb056e2fa34cb3047e730b84c2827cb3d7916ca839dbdc93d6e483cd976d496abb6b654617053c45a5a1730aaf383fcce15f6c2c83087d6bde4f8a510061249477db56bc1756ed71ad5cf1f0c873ee6b7d79e1dfcff941be71a46a763a2421e3114ce0e416ae49f69b7204cd1dd4501756ad0914fcf2089b35a83beced49fcd793b931ddb734ce4495b7bd54359051d91996d857d2e7967b1096d409becbbc7a84734a1b80639d686b68fb3deb93f9a7bb880503b9de8f5f8bdb227202953db3fb3f24ddf0dd5d5190cbc65a7bc11ecc0ebf4f99a04ba8e1a35354f9e75e43b7a9875e698b5b5f1cb03106cfb089082c6108f44f4bd3524b301fa8ac95d8bebc16d05d2c6e50a07232b2c0ac8db972fa6badc5a52e3b522314598b74c9083d308595bbd0a2dd96d1d961149d2e8e9444f22870d7783969795e86777bddd1a412d1c7324e3692daee4ab321514f87b0495e59ca34cbfa0ea2af1dff1d9ff187de44262fb916991eabd3ad94d6186179f174c4640fc523c6aa7acb009add94a8de353a4c354835029249e43a1ead85e981edcd1b9a8545e97534da79fd65729020ab51ad1305f9a12568119798fdc8e1154ceab53fe38e9d8d416e295bb47772761a42bc1691e4e6e32d69415e31bf9a00eb061ead74a28facf2f24513ff12aecf0d6cd43259bc737e467fd2f77b506ef930135159759877d1d832cfa9c2758fb546a716b6e3add3e94e49f48e7789b30d3e4214d246d3939b405a2416287968521b3d93951228a91b2454924374f5f70b9005bc0ecada81a31a1104e06b63d69a517cfec7a98",
                    );
                    /*
                    hexdata_test(
                        "c38e73657474696e672d6368616e6765887864672d6d656e7566",
                        "c02582c5dce598b939a82c0ed6398abb1bcea81f1fed5cb403499cea6b782835",
                    );
                    */
                }
                setTimeout(test_pydata, 1000);
            })
            .catch(err => {
                show("failed to derive AES key: "+err);
            });
        })
        .catch(err => {
            show("failed to import AES key: "+err);
        });
    </script>
  </body>
</html>
